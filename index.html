<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kameoka Farm | ÂÖ≠Ê¨°Áî£Ê•≠Âåñ„ÅÆÊú™Êù•</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <!-- Stripe SDK -->
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;300;400;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .lucide { stroke-width: 1.5px; }
        .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .5em 0 0 rgba(0,0,0,0), 1em 0 0 rgba(0,0,0,0); } 40% { color: white; text-shadow: .5em 0 0 rgba(0,0,0,0), 1em 0 0 rgba(0,0,0,0); } 60% { text-shadow: .5em 0 0 white, 1em 0 0 rgba(0,0,0,0); } 80%, 100% { text-shadow: .5em 0 0 white, 1em 0 0 white; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { motion, AnimatePresence } = Motion;

        const LANGUAGES = {
            ja: {
                heroTitle: "ÁîüÂëΩ„ÅÆÂ±•Ê≠¥„Çí„ÄÅÂë≥„Çè„ÅÜ„ÄÇ",
                heroSub: "Â§úÈñìÂõûÂæ©Ôºà„Çº„É≠„ÇØ„É≠„ÇπÔºâ„ÇíÁµå„Å¶ÂáùÁ∏Æ„Åï„Çå„Åü„ÄÅÊÉÖÂ†±„ÅÆË£ΩÈÄ†Ê•≠„Å®„Åó„Å¶„ÅÆÊûúÂÆü„ÄÇ",
                dashboardTitle: "ÂúÉÂ†¥„ÅÆ‰ªä",
                productsTitle: "ÊûúÂÆü„ÅÆ„É©„Ç§„É≥„Éä„ÉÉ„Éó",
                buyNow: "‰ªä„Åô„ÅêË≥ºÂÖ•",
                dataSugar: "Á≥ñÂ∫¶",
                aiGreeting: "‰∫ÄÂ≤°Ëæ≤Âúí„ÅÆAI„Ç≥„É≥„Ç∑„Çß„É´„Ç∏„É•„Åß„Åô„ÄÇ"
            },
            en: {
                heroTitle: "Taste the History of Life.",
                heroSub: "Condensed process of life through nocturnal recovery.",
                dashboardTitle: "Field Stats",
                productsTitle: "Collection",
                buyNow: "Buy Now",
                dataSugar: "Sugar",
                aiGreeting: "Hello, I am the AI Concierge."
            }
        };

        const PRODUCTS = [
            { id: 1, name: "Ê∏©Â∑û„Éü„Ç´„É≥", price: 4800, sugar: "13.5", key: "MIKAN", image: "https://images.unsplash.com/photo-1557800636-894a64c1696f?auto=format&fit=crop&q=80&w=800" },
            { id: 2, name: "ÂÖ´Êúî", price: 5200, sugar: "11.0", key: "HASSAKU", image: "https://images.unsplash.com/photo-1591133111033-fb90192091c0?auto=format&fit=crop&q=80&w=800" },
            { id: 3, name: "‰∏çÁü•ÁÅ´", price: 6500, sugar: "14.2", key: "SHIRANUI", image: "https://images.unsplash.com/photo-1611080626919-7cf5a9dbab5b?auto=format&fit=crop&q=80&w=800" }
        ];

        function App() {
            const [lang, setLang] = useState('ja');
            const [isAiOpen, setIsAiOpen] = useState(false);
            const [scrolled, setScrolled] = useState(false);
            const [loadingId, setLoadingId] = useState(null);
            const [globalError, setGlobalError] = useState("");
            
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || "");
            const [stripePk, setStripePk] = useState(localStorage.getItem('stripe_pk') || "");
            const [stripePriceIds, setStripePriceIds] = useState(JSON.parse(localStorage.getItem('stripe_price_ids') || "{}"));

            const t = LANGUAGES[lang];

            useEffect(() => {
                const handleScroll = () => setScrolled(window.scrollY > 50);
                window.addEventListener('scroll', handleScroll);
                lucide.createIcons();
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            useEffect(() => { lucide.createIcons(); }, [isAiOpen, lang, loadingId, globalError]);

            const handleCheckout = async (product) => {
                setGlobalError("");
                const cleanPk = stripePk.trim();
                const priceId = stripePriceIds[product.key]?.trim();

                if (!cleanPk || !priceId) {
                    setGlobalError("ERROR: „Ç≠„Éº„Åæ„Åü„ÅØ‰æ°Ê†ºID„ÅåÊú™Ë®≠ÂÆö„Åß„Åô„ÄÇ");
                    setIsAiOpen(true);
                    return;
                }

                setLoadingId(product.id);
                console.log("Stripe Redirect Attempt:", { cleanPk, priceId });
                
                try {
                    const stripe = Stripe(cleanPk);
                    const { error } = await stripe.redirectToCheckout({
                        lineItems: [{ price: priceId, quantity: 1 }],
                        mode: 'payment',
                        successUrl: window.location.href.split('?')[0] + '?status=success',
                        cancelUrl: window.location.href.split('?')[0] + '?status=cancel',
                    });

                    if (error) {
                        console.error("Stripe Redirection Error:", error);
                        // ÁîªÈù¢‰∏ä„Å´„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË©≥Á¥∞„Å´Ë°®Á§∫
                        setGlobalError(`STRIPE ERROR: ${error.message}`);
                        setLoadingId(null);
                    }
                } catch (e) {
                    console.error("Critical Runtime Error:", e);
                    setGlobalError(`SYSTEM ERROR: ${e.message}`);
                    setLoadingId(null);
                }
            };

            return (
                <div className="min-h-screen bg-[#FDFCFB] text-[#1A2F23]">
                    {/* Navigation */}
                    <nav className={`fixed top-0 w-full z-50 transition-all duration-500 ${scrolled ? 'bg-white/80 glass py-4 shadow-sm' : 'bg-transparent py-8'}`}>
                        <div className="container mx-auto px-6 flex justify-between items-center">
                            <div className="text-xl font-light tracking-[0.2em] uppercase">Kameoka <span className="font-bold">Farm</span></div>
                            <div className="flex items-center gap-6">
                                <button onClick={() => setLang(lang === 'ja' ? 'en' : 'ja')} className="text-xs tracking-widest hover:opacity-50 uppercase">
                                    {lang === 'ja' ? 'ENGLISH' : 'Êó•Êú¨Ë™û'}
                                </button>
                                <i data-lucide="shopping-cart" className="w-5 h-5 cursor-pointer"></i>
                            </div>
                        </div>
                    </nav>

                    {/* Hero */}
                    <section className="relative h-screen flex items-center justify-center text-center overflow-hidden bg-black">
                        <img src="https://images.unsplash.com/photo-1523348837708-15d4a09cfac2?auto=format&fit=crop&q=80&w=2000" className="absolute inset-0 w-full h-full object-cover z-0 opacity-70" alt="Hero" />
                        <div className="relative z-20 text-white px-6">
                            <motion.h1 initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="text-4xl md:text-7xl font-light mb-6 tracking-tight">{t.heroTitle}</motion.h1>
                            <p className="text-lg md:text-xl font-light opacity-80 mb-10 max-w-2xl mx-auto">{t.heroSub}</p>
                        </div>
                    </section>

                    {/* Error Banner (Visible when it fails) */}
                    {globalError && (
                        <div className="bg-red-600 text-white py-6 px-6 text-center text-sm font-bold sticky top-20 z-40 shadow-xl border-b border-red-700">
                            <div className="max-w-4xl mx-auto flex items-center justify-center gap-3">
                                <i data-lucide="alert-octagon" className="w-6 h-6"></i>
                                <span>{globalError}</span>
                            </div>
                        </div>
                    )}

                    {/* Products */}
                    <section className="py-32 bg-white">
                        <div className="container mx-auto px-6 text-center">
                            <h2 className="text-2xl font-light mb-16 tracking-widest uppercase">{t.productsTitle}</h2>
                            <div className="grid md:grid-cols-3 gap-12 text-left">
                                {PRODUCTS.map(p => (
                                    <div key={p.id} className="group">
                                        <div className="aspect-square overflow-hidden mb-6 bg-gray-100 relative">
                                            <img src={p.image} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700" />
                                        </div>
                                        <div className="flex justify-between items-end mb-4 px-1">
                                            <div>
                                                <h3 className="text-lg font-light">{p.name}</h3>
                                                <p className="text-xs text-gray-400 font-bold">¬•{p.price.toLocaleString()}</p>
                                            </div>
                                            <div className="text-[10px] text-gray-400 uppercase">{t.dataSugar}: {p.sugar}¬∞</div>
                                        </div>
                                        <button 
                                            onClick={() => handleCheckout(p)}
                                            disabled={loadingId === p.id}
                                            className="w-full py-4 bg-[#1A2F23] text-white text-[10px] tracking-widest uppercase font-bold hover:bg-orange-600 transition-all disabled:bg-gray-400"
                                        >
                                            {loadingId === p.id ? <span className="loading-dots">Redirecting</span> : t.buyNow}
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </section>

                    {/* Settings Button */}
                    <button onClick={() => setIsAiOpen(true)} className="fixed bottom-8 right-8 w-14 h-14 bg-orange-500 text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-110 active:scale-95 transition-all z-50">
                        <i data-lucide={(!apiKey || !stripePk) ? "settings" : "message-square"}></i>
                    </button>

                    <AnimatePresence>
                        {isAiOpen && (
                            <UnifiedModal 
                                onClose={() => setIsAiOpen(false)} t={t} lang={lang}
                                apiKey={apiKey} setApiKey={setApiKey}
                                stripePk={stripePk} setStripePk={setStripePk}
                                stripePriceIds={stripePriceIds} setStripePriceIds={setStripePriceIds}
                            />
                        )}
                    </AnimatePresence>
                </div>
            );
        }

        function UnifiedModal({ onClose, t, lang, apiKey, setApiKey, stripePk, setStripePk, stripePriceIds, setStripePriceIds }) {
            const [testResult, setTestResult] = useState("");
            
            const handleSave = () => {
                localStorage.setItem('gemini_api_key', apiKey.trim());
                localStorage.setItem('stripe_pk', stripePk.trim());
                localStorage.setItem('stripe_price_ids', JSON.stringify(stripePriceIds));
                alert("Settings Saved. The page will reload.");
                window.location.reload();
            };

            const testStripe = () => {
                if (!stripePk) { setTestResult("‚ùå Key is empty"); return; }
                try {
                    const s = Stripe(stripePk.trim());
                    setTestResult("‚úÖ Stripe.js Initialized Successfully");
                } catch (e) {
                    setTestResult("‚ùå Error: " + e.message);
                }
            };

            return (
                <motion.div initial={{ opacity: 0, y: 50 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 50 }} className="fixed bottom-24 right-8 w-[90vw] md:w-96 h-[550px] bg-white shadow-2xl rounded-2xl z-[60] flex flex-col overflow-hidden border border-gray-100">
                    <div className="bg-[#1A2F23] p-5 text-white flex justify-between items-center">
                        <span className="text-[10px] tracking-widest uppercase font-bold">System Setup</span>
                        <button onClick={onClose}><i data-lucide="x" className="w-5 h-5"></i></button>
                    </div>

                    <div className="flex-1 p-6 overflow-y-auto space-y-4 text-left">
                        <div>
                            <label className="text-[10px] uppercase text-gray-400 font-bold block mb-1">Stripe Public Key</label>
                            <input type="text" value={stripePk} onChange={e => setStripePk(e.target.value)} placeholder="pk_test_..." className="w-full p-2 text-xs border rounded bg-gray-50 outline-none" />
                            <button onClick={testStripe} className="text-[9px] mt-1 text-blue-600 underline uppercase">Test Connection</button>
                            {testResult && <p className="text-[9px] mt-1 font-bold">{testResult}</p>}
                        </div>

                        <div className="space-y-2">
                            <label className="text-[10px] uppercase text-gray-400 font-bold block">Price IDs</label>
                            {PRODUCTS.map(p => (
                                <div key={p.id} className="flex items-center gap-2">
                                    <span className="text-[8px] w-12 text-gray-400 font-bold uppercase">{p.key}</span>
                                    <input 
                                        type="text" 
                                        value={stripePriceIds[p.key] || ''} 
                                        onChange={e => setStripePriceIds({...stripePriceIds, [p.key]: e.target.value})} 
                                        placeholder={`price_...`} 
                                        className="flex-1 p-2 text-xs border rounded bg-gray-50 outline-none" 
                                    />
                                </div>
                            ))}
                        </div>

                        <div className="pt-4 border-t">
                            <label className="text-[10px] uppercase text-gray-400 font-bold block mb-1">Gemini API Key</label>
                            <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="AIza..." className="w-full p-2 text-xs border rounded bg-gray-50 outline-none" />
                        </div>

                        <button onClick={handleSave} className="w-full py-3 bg-orange-600 text-white text-[10px] font-bold uppercase tracking-widest rounded-lg mt-4 shadow-lg hover:bg-orange-700 transition-colors">Apply Changes</button>
                        
                        <div className="mt-8 p-3 bg-red-50 border border-red-100 rounded text-[9px] text-red-600 leading-relaxed uppercase">
                            <p className="font-bold mb-1">üî¥ IMPORTANT CHECKLIST:</p>
                            <ol className="list-decimal ml-3 space-y-1">
                                <li>Go to: Stripe Dashboard > Settings > Checkout</li>
                                <li>Enable <b>"Client-only integration"</b></li>
                                <li>Add your current URL (e.g. <b>*.vercel.app</b>) to <b>"Allowed domains"</b> in the same section.</li>
                            </ol>
                        </div>
                    </div>
                </motion.div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
