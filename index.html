<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kameoka Farm | 生命の履歴を味わう</title>
    <!-- 依存ライブラリ (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@200;400;700&family=Noto+Sans+JP:wght@100;300;400;700&display=swap');
        :root { --brand-green: #1A2F23; }
        body { font-family: 'Noto Sans JP', sans-serif; overflow-x: hidden; background-color: #FDFCFB; color: #1A2F23; -webkit-tap-highlight-color: transparent; }
        .font-serif { font-family: 'Noto Serif JP', serif; }
        .glass-nav { background: rgba(253, 252, 251, 0.9); backdrop-filter: blur(20px); }
        .reveal-img { transition: transform 1.5s cubic-bezier(0.2, 1, 0.3, 1); }
        .group:hover .reveal-img { transform: scale(1.08); }
        .fade-up { animation: fadeUp 1.2s ease forwards; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 安定したフェードイン */
        .simple-fade-in { animation: simpleFade 0.3s ease-in forwards; }
        @keyframes simpleFade { from { opacity: 0; } to { opacity: 1; } }

        html { scroll-behavior: smooth; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const Motion = window.Motion || window.framerMotion || { motion: { div: 'div' }, AnimatePresence: ({children}) => children };
        const { motion, AnimatePresence } = Motion;

        const LANGUAGES = {
            ja: {
                heroTitle: "生命の履歴を、味わう。",
                heroSub: "夜間回復（ゼロクロス）を経て凝縮された、情報の製造業としての果実。",
                dashboardTitle: "圃場の今",
                philosophyTitle: "引き算の美学",
                philosophySub: "余白が、本質を際立たせる。",
                philosophyText: "私たちは単に果物を育てているのではありません。土壌、光、風、そして植物の自己回復力をデータとして記録し、その「生命のプロセス」を価値としてお届けしています。",
                productsTitle: "Our Collection",
                buyNow: "購入ページへ",
                dataSugar: "糖度",
                aiGreeting: "亀岡農園のAIコンシェルジュです。今の気分に合わせて最適な果実を処方します。"
            },
            en: {
                heroTitle: "Taste the History.",
                heroSub: "Crafted as information, condensed through nocturnal recovery.",
                dashboardTitle: "Live Field Data",
                philosophyTitle: "Subtraction",
                philosophySub: "Minimalism reveals the essence.",
                philosophyText: "We record soil, light, and wind as data, delivering the process of life itself.",
                productsTitle: "Selection",
                buyNow: "Order Now",
                dataSugar: "Brix",
                aiGreeting: "I am your AI Concierge."
            }
        };

        const PRODUCTS = [
            { id: 1, name: "温州ミカン", price: 4800, sugar: "13.5", key: "MIKAN", description: "冬の陽光を閉じ込めた、王道の甘みと酸味。", image: "./img/mikan.jpg" },
            { id: 2, name: "八朔", price: 5200, sugar: "11.0", key: "HASSAKU", description: "清涼感あふれる苦味。大人のための洗練された柑橘。", image: "./img/hassaku.jpg" },
            { id: 3, name: "不知火", price: 6500, sugar: "14.2", key: "SHIRANUI", description: "濃厚なコクと突き抜ける甘み。最高傑作の不知火。", image: "./img/shiranui.jpg" }
        ];

        function App() {
            const [lang, setLang] = useState('ja');
            const [isAiOpen, setIsAiOpen] = useState(false);
            const [scrolled, setScrolled] = useState(false);
            const t = LANGUAGES[lang] || LANGUAGES.ja;

            // --- 数値シミュレーション (toFixedエラーを完全に防ぐ) ---
            const [fieldData, setFieldData] = useState({ temp: 24.5, humidity: 62, wind: 1.2, solar: 850 });

            useEffect(() => {
                const interval = setInterval(() => {
                    setFieldData(prev => ({
                        temp: Number(prev.temp) + (Math.random() - 0.5) * 0.2,
                        humidity: Math.min(100, Math.max(0, Number(prev.humidity) + Math.round((Math.random() - 0.5) * 2))),
                        wind: Math.max(0, Number(prev.wind) + (Math.random() - 0.5) * 0.1),
                        solar: Math.max(0, Number(prev.solar) + Math.round((Math.random() - 0.5) * 10))
                    }));
                }, 5000);
                
                const handleScroll = () => setScrolled(window.scrollY > 20);
                window.addEventListener('scroll', handleScroll);
                if (window.lucide) window.lucide.createIcons();
                
                return () => { clearInterval(interval); window.removeEventListener('scroll', handleScroll); };
            }, []);

            useEffect(() => { 
                if (window.lucide) window.lucide.createIcons(); 
            }, [isAiOpen, lang]);

            const handleCheckout = (product) => {
                let urls = {};
                try {
                    const saved = localStorage.getItem('stripe_urls');
                    if (saved) urls = JSON.parse(saved);
                } catch(e) { urls = {}; }
                const url = urls[product.key];
                if (!url) { setIsAiOpen(true); return; }
                window.location.href = url;
            };

            return (
                <div className="min-h-screen">
                    {/* ナビゲーション */}
                    <nav className={`fixed top-0 w-full z-50 transition-all duration-500 ${scrolled ? 'glass-nav py-3 shadow-sm' : 'bg-transparent py-6 md:py-10'}`}>
                        <div className="container mx-auto px-5 md:px-10 flex justify-between items-center text-[#1A2F23]">
                            <div className="text-lg md:text-xl font-light tracking-[0.3em] uppercase">Kameoka <span className="font-bold">Farm</span></div>
                            <button onClick={() => setLang(lang === 'ja' ? 'en' : 'ja')} className="text-[10px] tracking-widest uppercase font-bold border-b border-current">{lang === 'ja' ? 'EN' : 'JA'}</button>
                        </div>
                    </nav>

                    {/* ヒーロー */}
                    <section className="relative h-screen flex items-center justify-center overflow-hidden bg-gray-900 text-center">
                        <img src="./img/hero.jpg" className="absolute inset-0 w-full h-full object-cover opacity-60" alt="Hero" />
                        <div className="relative z-10 text-white px-6 fade-up">
                            <h1 className="font-serif text-3xl md:text-8xl font-light mb-6 tracking-wider leading-snug">{t.heroTitle}</h1>
                            <p className="text-[10px] md:text-sm tracking-[0.2em] uppercase opacity-90 mb-10 max-w-lg mx-auto leading-loose">{t.heroSub}</p>
                            <button onClick={() => document.getElementById('products').scrollIntoView()} className="px-10 py-3 border border-white/40 backdrop-blur-md text-[10px] tracking-[0.3em] uppercase font-bold hover:bg-white hover:text-[#1A2F23] transition-all">Explore</button>
                        </div>
                    </section>

                    {/* データ表示 */}
                    <section className="py-12 bg-[#1A2F23] text-white">
                        <div className="container mx-auto px-6 grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
                            <DataPoint label="Field Temp" value={`${Number(fieldData.temp).toFixed(1)}°C`} />
                            <DataPoint label="Humidity" value={`${Number(fieldData.humidity)}%`} />
                            <DataPoint label="Wind" value={`${Number(fieldData.wind).toFixed(1)}m`} />
                            <DataPoint label="Solar" value={`${Number(fieldData.solar)}w`} />
                        </div>
                    </section>

                    {/* 哲学セクション */}
                    <section className="py-20 md:py-32 bg-white text-left text-[#1A2F23]">
                        <div className="container mx-auto px-6 grid md:grid-cols-2 gap-12 md:gap-24 items-center">
                            <motion.div initial={{ opacity: 0 }} whileInView={{ opacity: 1 }} viewport={{ once: true }}>
                                <img src="./img/philosophy.jpg" className="w-full aspect-square object-cover shadow-xl grayscale hover:grayscale-0 transition-all duration-1000" alt="Philosophy" />
                            </motion.div>
                            <div className="space-y-6">
                                <h2 className="text-[10px] tracking-[0.4em] uppercase font-bold text-gray-400">{t.philosophyTitle}</h2>
                                <h3 className="font-serif text-3xl md:text-5xl font-light leading-tight">{t.philosophySub}</h3>
                                <p className="text-gray-500 font-light leading-relaxed text-base md:text-lg">{t.philosophyText}</p>
                            </div>
                        </div>
                    </section>

                    {/* 商品一覧 */}
                    <section id="products" className="py-20 md:py-32 bg-[#F8F9FA]">
                        <div className="container mx-auto px-6">
                            <h2 className="font-serif text-3xl md:text-4xl font-light mb-16 text-center tracking-[0.2em] uppercase">{t.productsTitle}</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-12 md:gap-16">
                                {PRODUCTS.map(p => (
                                    <div key={p.id} className="group text-left">
                                        <div className="aspect-[4/5] overflow-hidden mb-6 relative shadow-lg">
                                            <img src={p.image} className="w-full h-full object-cover reveal-img" alt={p.name} />
                                            <div className="absolute top-3 left-3 bg-white/90 px-2 py-1 text-[7px] font-bold tracking-widest uppercase">Batch #24-{p.id}</div>
                                        </div>
                                        <div className="space-y-3">
                                            <div className="flex justify-between items-end">
                                                <h3 className="font-serif text-xl md:text-2xl font-light">{p.name}</h3>
                                                <span className="text-[9px] text-gray-400 font-bold uppercase">{t.dataSugar}: {p.sugar}°</span>
                                            </div>
                                            <p className="text-[11px] text-gray-400 font-light leading-relaxed h-8 line-clamp-2">{p.description}</p>
                                            <button onClick={() => handleCheckout(p)} className="w-full mt-4 py-3 bg-[#1A2F23] text-white text-[9px] font-bold uppercase tracking-[0.2em] hover:bg-orange-600 transition-colors">
                                                {t.buyNow}
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </section>

                    <footer className="py-16 bg-white border-t border-gray-100 text-center">
                        <div className="text-sm font-light tracking-[0.4em] uppercase mb-4">Kameoka Farm</div>
                        <p className="text-[9px] text-gray-300 tracking-[0.2em]">&copy; 2024 Information Manufacturing.</p>
                    </footer>

                    <button onClick={() => setIsAiOpen(true)} className="fixed bottom-5 right-5 w-14 h-14 bg-[#1A2F23] text-white rounded-full shadow-2xl flex items-center justify-center z-50 shadow-black/20 hover:scale-105 transition-transform">
                        <i data-lucide="message-square" className="w-5 h-5"></i>
                    </button>

                    <AnimatePresence>
                        {isAiOpen && (
                            <UnifiedModal onClose={() => setIsAiOpen(false)} t={t} lang={lang} />
                        )}
                    </AnimatePresence>
                </div>
            );
        }

        function DataPoint({ label, value }) {
            return (
                <div className="space-y-1">
                    <p className="text-[7px] uppercase tracking-widest opacity-50 font-bold">{label}</p>
                    <p className="text-lg md:text-xl font-light">{value}</p>
                </div>
            );
        }

        function UnifiedModal({ onClose, t, lang }) {
            // 初期データの安全な読み込み
            const [stripeUrls, setStripeUrls] = useState(() => {
                try {
                    const saved = localStorage.getItem('stripe_urls');
                    return saved ? JSON.parse(saved) : {};
                } catch(e) { return {}; }
            });
            const [view, setView] = useState(() => localStorage.getItem('gemini_api_key') ? 'chat' : 'settings');
            const [isLocked, setIsLocked] = useState(!!localStorage.getItem('gemini_api_key'));
            const [apiKey, setApiKey] = useState(""); 
            const [messages, setMessages] = useState([{ role: 'ai', text: t.aiGreeting }]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => { 
                if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; 
                // アイコン描画を確実にするためのタイマー
                const timer = setTimeout(() => {
                    if (window.lucide) window.lucide.createIcons();
                }, 200);
                return () => clearTimeout(timer);
            }, [messages, view, isLocked]);

            const handleSave = () => {
                if(apiKey.trim()) localStorage.setItem('gemini_api_key', apiKey.trim());
                localStorage.setItem('stripe_urls', JSON.stringify(stripeUrls));
                setApiKey(""); 
                setIsLocked(true);
                alert("設定を保存しました。画面を再読み込みします。"); 
                window.location.reload();
            };

            const handleSend = async () => {
                const storedKey = localStorage.getItem('gemini_api_key');
                if (!input.trim() || !storedKey || loading) return;
                const userMsg = input; setInput('');
                setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
                setLoading(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${storedKey.trim()}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userMsg }] }],
                            systemInstruction: { parts: [{ text: `あなたは農園コンシェルジュです。上品かつ知的に回答してください。` }] }
                        })
                    });
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Response Error.";
                    setMessages(prev => [...prev, { role: 'ai', text: text }]);
                } catch (err) { setMessages(prev => [...prev, { role: 'ai', text: "Connection error." }]); }
                finally { setLoading(false); }
            };

            return (
                <motion.div initial={{ opacity: 0, y: 50 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 50 }} className="fixed inset-x-4 bottom-24 md:inset-auto md:bottom-32 md:right-10 md:w-[400px] h-[70vh] md:h-[600px] bg-white shadow-3xl rounded-3xl z-[60] flex flex-col overflow-hidden border border-gray-100 shadow-black/10">
                    <div className="bg-[#1A2F23] p-5 text-white flex justify-between items-center text-[10px] tracking-widest uppercase font-bold">
                        <div className="flex gap-6">
                            <button onClick={() => setView('chat')} className={view === 'chat' ? 'border-b border-white' : 'opacity-40'}>Chat</button>
                            <button onClick={() => setView('settings')} className={view === 'settings' ? 'border-b border-white' : 'opacity-40'}>Setup</button>
                        </div>
                        <button onClick={onClose}><i data-lucide="x" className="w-4 h-4"></i></button>
                    </div>

                    <div className="flex-1 overflow-y-auto bg-[#FDFCFB]">
                    {view === 'settings' ? (
                        <div className="p-8 space-y-6 text-left simple-fade-in">
                            <div className="flex items-center justify-between border-b border-gray-100 pb-4">
                                <h3 className="text-[11px] font-bold tracking-widest uppercase opacity-60 flex items-center gap-2">
                                    <i data-lucide={isLocked ? "lock" : "unlock"} className="w-3 h-3"></i> Setup
                                </h3>
                                {isLocked && (
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); setIsLocked(false); }} 
                                        className="text-[9px] font-bold border border-gray-200 px-3 py-1 rounded-full bg-white hover:bg-gray-100 transition-all"
                                    >
                                        編集する
                                    </button>
                                )}
                            </div>

                            {isLocked ? (
                                <div className="py-12 text-center space-y-4">
                                    <i data-lucide="shield-check" className="w-10 h-10 text-green-600 mx-auto"></i>
                                    <p className="text-[11px] text-gray-400 px-6 leading-relaxed">設定情報はブラウザ内に安全に保管されています。</p>
                                </div>
                            ) : (
                                <div className="space-y-6 pb-4">
                                    <div className="space-y-4">
                                        {PRODUCTS.map(p => (
                                            <div key={p.id}>
                                                <span className="text-[9px] text-gray-400 font-bold uppercase">{p.name} URL</span>
                                                <input 
                                                    type="text" 
                                                    value={stripeUrls[p.key] || ''} 
                                                    onChange={e => setStripeUrls({...stripeUrls, [p.key]: e.target.value})} 
                                                    className="w-full p-3 text-xs border border-gray-200 rounded-xl bg-white mt-1 outline-none focus:ring-1 focus:ring-gray-200" 
                                                    placeholder="https://buy.stripe.com/..." 
                                                />
                                            </div>
                                        ))}
                                    </div>
                                    <div className="pt-6 border-t border-gray-100">
                                        <span className="text-[9px] text-gray-400 font-bold uppercase">Gemini API Key</span>
                                        <input 
                                            type="password" 
                                            value={apiKey} 
                                            onChange={e => setApiKey(e.target.value)} 
                                            className="w-full p-3 text-xs border border-gray-200 rounded-xl bg-white mt-1 outline-none focus:ring-1 focus:ring-gray-200" 
                                            placeholder="AIza... (上書き時のみ入力)" 
                                        />
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setIsLocked(true)} className="flex-1 py-4 border border-gray-200 text-gray-400 text-[10px] font-bold rounded-xl hover:bg-gray-50 transition-colors">Cancel</button>
                                        <button onClick={handleSave} className="flex-[2] py-4 bg-[#1A2F23] text-white text-[10px] font-bold rounded-xl shadow-lg active:scale-95 transition-transform">Save Changes</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="p-6 space-y-4 simple-fade-in">
                            <div ref={scrollRef} className="space-y-4 min-h-[300px]">
                                {messages.map((m, i) => (
                                    <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[85%] p-4 text-xs ${m.role === 'user' ? 'bg-[#1A2F23] text-white rounded-2xl rounded-tr-none shadow-md' : 'bg-white border border-gray-100 rounded-2xl rounded-tl-none font-light shadow-sm'}`}>{m.text}</div>
                                    </div>
                                ))}
                                {loading && <div className="text-[8px] animate-pulse opacity-40 ml-1">AI Thinking...</div>}
                            </div>
                        </div>
                    )}
                    </div>

                    {view === 'chat' && (
                        <div className="p-4 border-t flex gap-2 bg-white">
                            <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} placeholder="Ask me anything..." className="flex-1 text-sm p-3 bg-gray-50 rounded-xl outline-none" />
                            <button onClick={handleSend} className="p-3 bg-[#1A2F23] text-white rounded-xl active:scale-95 transition-transform"><i data-lucide="send" className="w-4 h-4"></i></button>
                        </div>
                    )}
                </motion.div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
